---
title: "R Notebook"
output: html_notebook
---

# Chickadee Pathogen Data Statistical Analysis

## TRU 4001 - Biostatistics - Final Project

## Introduction

This is a personal notebook which accompanies the final project for Thompson Rivers University's Biology 4001, Biostatistics taught by Professor Iain Pardoe. The submission is a report which in the style of a research paper in biology.

This notebook includes the task requirements, as well as other statistical techniques which may be useful to carry out and document. The notebook shall serve as a general guideline and template for statistical analyses for future work.

## 1. Problem Definition

### Problem Space

Data from nest boxes at 47 mountain chickadee sites was collected to examine microbial community compositions associated with chickadees in urban, semi-urban, and rural environments. DNA sequencing was used to determine the relative abundance of different microbial taxa present in swabs from either chickadee nests or feathers in nest boxes in these three habitat types. Nest boxes were set up to encourage nesting in the sample sites. For the feather data, physical characteristics of the birds were recorded. The data was also used to determine two different measures of microbial species richness (alpha diversity) at each site.

From the description, it appears that we are interested in microbial community compositions, particularly pathogenic bacteria species, and their relationship with features of mountain chickadees.

### Type of Problem

-   Determine whether the problem is a descriptive study, hypothesis testing, estimation, prediction, etc.

There are various problems in this task, including descriptive studies, hypothesis testing, estimation, and prediction.

### Task/Question/Hypothesis

-   Clearly Define the questions to be answered or the hypotheses to be tested.

-   Make sure all the information needed to answer each question is provided (e.g., for questions that ask you to do a test, state the hypotheses you\'re testing, the test statistic and p-value obtained from R, the decision based on a significance level of 5%, and the conclusion in the context of the question).

    #### (Graded)

    \-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--

-   Summarize the data in **`ChickadeeData.csv`** numerically.

-   Summarize the data in **`ChickadeeData.csv`** graphically.

-   Use a two-sample *t*-test to determine whether the mean abundance of bacteria identified as genus *Escherichia/Shigella* differs significantly between nests and feathers. [Consider transforming variable **`EscShi`** and use R function **`t.test`**. Be careful when applying the natural logarithm transformation to data containing zeros since ln(0) is undefined. The usual way around this is to calculate ln(y+1) instead of ln(y).]

-   Use a Mann-Whitney U-test (Wilcoxon rank sum test) to determine whether the population distribution of the abundance of bacteria identified as genus *Escherichia/Shigella* differs significantly between nests and feathers. [Use R function **`wilcox.test`**.]

-   Use a two-sample *t*-test to determine whether the mean abundance of bacteria identified as genus *Enterococcus* differs significantly between nests and feathers. [Consider transforming variable **`Entero`** and use R function **`t.test`**.]

-   Use a Mann-Whitney U-test (Wilcoxon rank sum test) to determine whether the population distribution of the abundance of bacteria identified as genus *Enterococcus* differs significantly between nests and feathers. [Use R function **`wilcox.test`**.]

-   Use analysis of variance to determine whether mean pathogen richness is related to habitat. [Use R functions **`lm`** and **`anova`**.]

-   Use a Kruskal-Wallis test to determine whether mean pathogen richness is related to habitat. [Use R function **`kruskal.test`**.]

-   Use the Tukey-Kramer method to which habitats differ with respect to mean pathogen richness. [Use R functions **`emmeans`** and **`contrast`**.]

-   Use contingency table analysis to determine whether community richness on feathers is independent of mountain chickadees sex? [Use R function **`filter`** in the **`dplyr`** package to subset the data frame to retain only feather swabs, then use R functions **`table`** and **`chisq.test`**.]

-   Use simple linear regression to determine which of **`WingChord`**, **`BirdWeight`**, **`TailLen`**, or **`TarsusLen`** is most linearly associated with pathogen richness on feathers. [Use R functions **`lm`** and **`summary`**.]

-   For the simple linear regression model selected in Question 11, investigate whether there are any outliers. An outlier in the context of linear regression is an observation with an extreme difference between the observed response value and the predicted response value from the model. Use the **`filter`** function to create a new data frame that excludes the most extreme outlier and refit the simple linear regression model. Report the results for the model fit to the data frame excluding the outlier and use this data frame to answer Questions 13-18.

-   Find the best multiple linear regression model for predicting pathogen richness on feathers from two predictors out of **`WingChord`**, **`BirdWeight`**, **`TailLen`**, and **`TarsusLen`**. [Use R functions **`lm`** and **`summary`**.]

-   Use a two-sample *t*-test to determine whether mean pathogen richness on feathers differs significantly between male and female birds. [Use R function **`t.test`**.]

-   Starting from the simple linear regression model in Question 12, use analysis of covariance to investigate whether the linear association in the model differs for male and female birds. [Use R functions **`lm`** and **`summary`**.]

-   Apply principal component analysis to the variables **`WingChord`**, **`BirdWeight`**, **`TailLen`**, and **`TarsusLen`**. [Use R functions **`scale`**, **`prcomp`**, and **`summary`**. Also, summarize the principal component loadings and use R function **`fviz_pca_ind`** with argument **`habillage`** to visualize the results and colour the observations by bird sex.]

-   Fit a simple linear regression model with response variable **`PathRich`** and predictor variable equal to the first principal component from Question 16. Compare this model with the simple linear regression model in Question 12. [Use R functions **`lm`** and **`summary`**.]

-   Fit a multiple linear regression model with response variable **`PathRich`** and predictor variables equal to the first two principal components from Question 16. Compare this model with the multiple linear regression model in Question 13. [Use R functions **`lm`** and **`summary`**.]

-   Apply metric multidimensional scaling (MDS) to the dissimilarities data in the **`ChickadeeDissimilarities.csv`** file. [Use R function **`cmdscale`** to perform the metric MDS and use function **`ggplot`** to create a scatterplot that projects the data onto the first two principal coordinates. Then use the **`shape`** aesthetic to first mark the points by **`Habitat`** and then by **`Source`**.] Does the composition of the microbial communities appear to be related to **`Habitat`** or **`Source`**?

-   Apply nonmetric multidimensional scaling (NMDS) to the dissimilarities data in the **`ChickadeeDissimilarities.csv`** file. [Use R function **`metaMDS`** to perform the NMDS and use function **`ggplot`** to create a scatterplot that projects the data onto the first two NMDS axes. Then use the **`shape`** aesthetic to first mark the points by **`Habitat`** and then by **`Source`**.] Does the composition of the microbial communities appear to be related to **`Habitat`** or **`Source`**?

\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--

## 2. Data Collection and Preprocessing

### Data Source

-   Identify the sources of data, whether it is from an experiment, survey, existing dataset, etc.

The data in the **`ChickadeeData.csv`** file consist of the following variables:

-   **`Site`** = Name of the site

-   **`Habitat`** = Whether the nest box is in an urban, semi-urban, or rural habitat

-   **`Source`** = Whether the swab was taken from a nest or a feather

-   **`EscShi`** = Abundance of pathogenic bacteria identified as genus *Escherichia/Shigella*

-   **`Entero`** = Abundance of pathogenic bacteria identified as genus *Enterococcus*

-   **`CommRich`** = Categorical measure of alpha diversity equal to "high" if the number of unique bacterial species present in the swab exceeds 400, or equal to "low" otherwise

-   **`PathRich`** = Quantitative measure of alpha diversity equal to the number of unique potentially pathogenic bacteria species present in the swab

-   **`WingChord`** = Measure of bird wing size (for feather swabs only)

-   **`BirdWeight`** = Measure of bird weight (for feather swabs only)

-   **`TailLen`** = Measure of bird tail length (for feather swabs only)

-   **`TarsusLen`** = Measure of bird tarsus length (for feather swabs only)

-   **`BirdSex`** = Sex of the bird (for feather swabs only)

Microbial community composition data for 2607 taxa was also used to calculate Bray Curtis dissimilarities between the 47 sites; these are in the **`ChickadeeDissimilarities.csv`** file.

### Data Cleaning

-   Preprocess the data to handle missing values, outliers, or other anomalies.

As the dataset was provided as an assignment, no preprocessing is required. However, let us do a basic check for null values:

```{r}
# Read the data
chickadeeData <- read.csv("ChickadeeData.csv")
dissimilaritiesData <- read.csv("ChickadeeDissimilarities.csv")

# Check for Missing Data in the Entire Dataset
sum(is.na(chickadeeData))

# Check for Missing Data Column-wise
colSums(is.na(chickadeeData))

# Check for Missing Data Row-wise
rowSums(is.na(chickadeeData))

# Visualizing Missing Data
library(visdat)
vis_miss(chickadeeData)


# Now for dissimilarities data

# Check for Missing Data in the Entire Dataset
sum(is.na(dissimilaritiesData))

# Check for Missing Data Column-wise
colSums(is.na(dissimilaritiesData))

# Check for Missing Data Row-wise
rowSums(is.na(dissimilaritiesData))

# Visualizing Missing Data
vis_miss(dissimilaritiesData)

```

It appears that 15.1% of the chickadee dataset is missing, while there is no null data in the dissimilarities dataset.

For now, we will leave it as we develop a better understanding of the data and the problem.

### Experimental Design Considerations

-   Designing Effective Experiments: consider (a) reducing bias in estimating and testing treatment effects, and (b) reducing the effects of sampling error.

-   Topics in experimental design include randomized controlled trials, control groups, treatment groups, and experimental controls.

-   Reduce bias: Use Simultaneous control group, randomization, and blinding.

-   Reduce the influence of sampling error: Replication, balance, blocking, and extreme treatments.

-   If you can't do experiments: Match and adjust.

-   Sample size: Plan for precision, power, and data loss.

-   A priori tests or analyses.

### Feature Engineering

-   Deriving new variables that might be relevant for analysis.

### Data Transformation

-   Such as normalization, standardization, or logarithmic transformation if required.
-   Generally, scaling is required when: variables are measured in different units, When the algorithm is based on distance or gradient, or for interpretability.

## 3. Exploratory Data Analysis

-   Exploratory Data Analysis (EDA) is an essential step in understanding the data, identifying patterns, spotting anomalies, and developing an intuition about the relationships between variables.

### Data Inspection

-   The first step should be to open and inspect the dataset (even in a spreadsheet). View the first few lines and familiarize yourself with the variable names.

-   A good first goal is to find a plot type that clearly and efficiently visualizes the patterns in the data, especially the differences among groups.

Let us open and inspect the data in excel, to get a first glance. The variables and the data are already described in the assignment.

### Setup

```{r}
# setwd("C:\\Users\\JP\\Desktop\\RECENT\\Biology\\BIOL 4001 - Biostatistics\\Final")
library(ggplot2)
library(dplyr)
library(emmeans)
library(GGally)
library(factoextra)
library(ggrepel)
library(vegan)
library(Hmisc)
library(car)
library(pheatmap)
library(photobiology)
library(ggrepel)
library(reshape2)
library(rgl)
library(vcd)
library(ade4)
theme_set(theme_classic())

```

### Summary Statistics

-   Measures of Central Tendency: Mean, median, and mode.

-   Measures of Spread: Variance, standard deviation, range, interquartile range (IQR).

-   Measures of Shape: Skewness (asymmetry) and kurtosis (tailedness).

-   Percentiles: Quantiles including the quartiles.

-   Correlation: Correlation coefficients to measure linear relationships between variables.

-   Summary Statistics by Group.

-   Summarize the data in **`ChickadeeData.csv`** numerically.

```{r}
# Summarize data
summary(chickadeeData)
head(chickadeeData)

# See column names
names(chickadeeData)

# Check unique values of a specific column
unique(chickadeeData$Source)

# Detailed summary of dataframe
str(chickadeeData)

# Summarize each variable using Hmisc
describe(chickadeeData)

# Use a table to display example categorical variable
chickadeeTableEscShi <- table(chickadeeData$EscShi)
chickadeeTableEscShi

chickadeeTableEntero <- table(chickadeeData$Entero)
chickadeeTableEntero

```

### Visualizations

-   Histograms: To understand the distribution of a single variable.

-   Scatter Plots: To visualize relationships between two continuous variables.

-   Box Plots: To see the spread and skewness across categories.

-   Heatmaps: For visualizing correlation matrices or two-way frequency tables.

-   Pair Plots: A set of scatter plots for all pairs of variables to see relationships and distributions.

-   Time Series Plots: If the data is a time series, to visualize trends and seasonality.

-   Summarize the data in **`ChickadeeData.csv`** graphically.

```{r}

# Visualize frequency distributions of single variables

# Bar charts for categorical variables

# Habitat
ggplot(data = chickadeeData, aes(x = Habitat)) +
geom_bar(stat = "count") +
labs(x = "Habitat", y = "Frequency") +
theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Source
ggplot(data = chickadeeData, aes(x = Source)) +
geom_bar(stat = "count") +
labs(x = "Source", y = "Frequency") +
theme(axis.text.x = element_text(angle = 90, hjust = 1))

# CommRich
ggplot(data = chickadeeData, aes(x = CommRich)) +
geom_bar(stat = "count") +
labs(x = "Alpha Diversity", y = "Frequency") +
theme(axis.text.x = element_text(angle = 90, hjust = 1))

# BirdSex
ggplot(data = chickadeeData, aes(x = BirdSex)) +
geom_bar(stat = "count") +
labs(x = "Sex", y = "Frequency") +
theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Histograms for numerical variables

# EscShi
ggplot(data = chickadeeData, aes(x = EscShi)) +
geom_histogram(col = "black", binwidth = 50,
boundary = 0, closed = "left") +
labs(x = "EscShi", y = "Frequency")

# Entero
ggplot(data = chickadeeData, aes(x = Entero)) +
geom_histogram(col = "black", binwidth = 10,
boundary = 0, closed = "left") +
labs(x = "Entero", y = "Frequency")

# PathRich
ggplot(data = chickadeeData, aes(x = PathRich)) +
geom_histogram(col = "black", binwidth = 4,
boundary = 0, closed = "left") +
labs(x = "Alpha Diversity", y = "Frequency")

# WingChord
ggplot(data = chickadeeData, aes(x = WingChord)) +
geom_histogram(col = "black", binwidth = 1,
boundary = 0, closed = "left") +
labs(x = "Wing Size", y = "Frequency")

# BirdWeight
ggplot(data = chickadeeData, aes(x = BirdWeight)) +
geom_histogram(col = "black", binwidth = 0.5,
boundary = 0, closed = "left") +
labs(x = "Weight", y = "Frequency")

# TailLen
ggplot(data = chickadeeData, aes(x = TailLen)) +
geom_histogram(col = "black", binwidth = 1,
boundary = 0, closed = "left") +
labs(x = "Tail Length", y = "Frequency")

# TarsusLen
ggplot(data = chickadeeData, aes(x = TarsusLen)) +
geom_histogram(col = "black", binwidth = 0.2,
boundary = 0, closed = "left") +
labs(x = "Tarsus Length", y = "Frequency")



# Relationship between 2 variables

# Box Plot for numerical variable vs categorical variable
ggplot(chickadeeData, aes(x=BirdSex, y=TarsusLen)) + geom_boxplot()

# Scatter Plots
ggplot(chickadeeData,   
  aes(x = BirdWeight, 
  y = EscShi)) +
  geom_point()

ggplot(chickadeeData,   
  aes(x = TarsusLen, 
  y = PathRich)) +
  geom_point()

# Strip Chart
ggplot (data = chickadeeData, aes(x = WingChord, y = Entero)) +
geom_jitter(shape = 1, size = 2, width = 0.15) +
labs(x = "Wing Size", y = "Entero")

# Violin Plot
ggplot(data = chickadeeData, aes(y = BirdWeight, x = TailLen)) +
geom_violin() +
labs(x = "Tail Length", y = "BirdWeight") +
stat_summary(fun = mean, geom = "point")


```

Some initial exploration of the variables have given us some familiarity with the dataset.

### Probability (Distributions)

-   Explore and identify the probability distributions of variables, obtain probability mass and density functions.

-   Common Discrete Probability Distributions: Binomial, Discrete Uniform, Poisson.

-   Create probability table for categorical variables.

-   Create probability mass functions (pmf) for discrete probability distributions.

-   Common Continuous Probability Distributions: Normal, Continuous, Log-Normal, Exponential.

-   Create probability density functions (pdf) and/or cumulative density functions (cdf) for continuous probability distributions.

-   You can find the expected value and standard deviation of a probability distribution if you have the formula, sample, or probability table of the distribution (which are used in tests below).

### Dimensionality Reduction

-   Techniques like t-SNE in addition to PCA, especially for visualizing high-dimensional data.

### Other Techniques

-   Missing Value Analysis: Identifying and analyzing missing data.

-   Outlier Detection: Methods to detect and analyze unusual observations.

-   Categorical Data Analysis: Frequency tables, bar charts, pie charts for categorical variables.

-   Multivariate Analysis: Techniques like Principal Component Analysis (PCA) to understand the relationships among multiple variables.

-   Cross-Tabulations: Also known as contingency tables; useful for understanding the relationship between two categorical variables.

-   Spatial Analysis: If the data has geographical attributes, spatial visualization, and analysis might be essential.

-   Text Analysis: If the dataset contains text, basic text mining techniques might be applicable.

### Initial Tests

-   Normality Tests: Checking if a variable follows a normal distribution.

-   Homogeneity of Variances: Testing if the variances are equal across groups.

### Relationships

-   Correlation: Understand statistical association between variables.

-   Covariance: Understanding how two variables change together.

-   Regression Analysis/Plots: Simple linear regression to visually understand relationships.

-   Effect Size: Understanding the magnitude of relationships between variables.

### Contingency Analysis

-   Association: Understanding if there is an association between the categories of different variables.

-   Independence Testing: Statistical tests like the Chi-Squared Test for Independence can be applied to contingency tables to determine if there is a significant association between the variables.

-   Conditional Probabilities: You can calculate conditional probabilities to understand how the probability of one event changes given the knowledge of another event.

-   Comparison Across Groups: If you have more than two categorical variables, you can explore how the relationship between two variables may differ across the levels of a third variable.

-   Marginal Distribution: You can analyze the marginal distribution of one variable irrespective of the others. This gives insights into the overall distribution of a particular variable.

-   Expected Frequencies: In some cases, you might want to compare observed frequencies in the contingency table with expected frequencies under some statistical model. This can give insights into how well a given model fits your data.

-   Use contingency table analysis to determine whether community richness on feathers is independent of mountain chickadees sex? [Use R function **`filter`** in the **`dplyr`** package to subset the data frame to retain only feather swabs, then use R functions **`table`** and **`chisq.test`**.

```{r}

# Confirm the column to be filtered
unique(chickadeeData$Source)

# Filter df for Source = feather
df_feather <- filter(chickadeeData, Source == 'feather')
df_feather

# Check the order of the categories
chickadeeData$CommRich
unique(chickadeeData$CommRich)
# They are already ordered

# Order the categories as desired by turning into a factor variable (if needed. This is useful for more than 2 categories)
CommRich_BirdSex_table$CommRich <-
factor(CommRich_BirdSex_table$CommRich,
levels = c("low", "high"))

# Create 2x2 Contingency Table for community richness and sex
CommRich_BirdSex_table <- table(df_feather$CommRich, df_feather$BirdSex)
CommRich_BirdSex_table
str(CommRich_BirdSex_table)

# Create a mosaic plot to visualize the data
par(pty = "s") # makes a square plot
mosaicplot(t(CommRich_BirdSex_table), col = c("firebrick", "goldenrod1"),
cex.axis = 1, main = "",
sub = "Infection status", ylab = "Relative frequency")

# Conduct a Chi-squared Test of Independence of Two Categorical Variables
Xsq <- chisq.test(CommRich_BirdSex_table, correct = FALSE)
Xsq
```

As the p-value is less than the alpha level of 0.05, there is not enough evidence to conclude that there is an association between community richness and bird sex, based on the Chi-squared test of the contingency table analysis. From these results, we would fail to accept the null hypothesis of independence of the variables.

Simply said, there is no reason to assume that the pathogen community richness on feathers would differ due to the birds' sex.

## 4. Model Specification

### Statistical Model

-   Choose an appropriate statistical model that aligns with the type of data and research question.

### Estimator

-   Decide on the method of estimation (e.g., Maximum Likelihood, Least Squares, etc.).

### Hyperparameters

-   If you're working with models that require hyperparameter tuning, choose the appropriate values or ranges and methods (like grid search or random search).

## 5. Statistical Inference - Hypothesis Testing (if applicable)

### Null and Alternative Hypotheses

-   Define the hypotheses to be tested.

### Test Statistic

-   Decide on the level of significance (e.g., α = 0.05).

### P-value

-   Compute the p-value to determine statistical significance.

### Conclusion

-   Make a decision to accept or reject the null hypothesis based on the p-value.

### Post-Hoc Analysis

-   Tests or Analyses that are performed after the initial hypothesis test to explore the data further, especially when the initial test indicates a significant result.

Note that in R, statistical tests are performed through functions and summarized for you, rather than having to manually implement them (while you can calculate them by hand).

The statistician should handle:

-   The interpretation of the tests. A p-value by itself does not "prove" anything.

-   Underlying assumptions that built-in functions do not automatically check for.

-   Choice of test: ensure that the appropriate test for the data and research question is applied.

-   Data pre-processing: the data must be processed such that the test can be ran on it, handling issues like outliers, missing data, or necessary transformations.

-   Multiple comparisons: generally, research questions will involve comparing the results of multiple tests on the data, and forming an interpretation.

Let us perform the tests of the assignment.

-   Use a two-sample *t*-test to determine whether the mean abundance of bacteria identified as genus *Escherichia/Shigella* differs significantly between nests and feathers. [Consider transforming variable **`EscShi`** and use R function **`t.test`**. Be careful when applying the natural logarithm transformation to data containing zeros since ln(0) is undefined. The usual way around this is to calculate ln(y+1) instead of ln(y).]

As we saw above, EscShi data appears to be Log-normal (having a right-skewed distribution), and could benefit from a natural log transformation. Let us visualize this.

```{r}
# EscShi untransformed
ggplot(data = chickadeeData, aes(x = EscShi)) +
geom_histogram(col = "black", binwidth = 50,
boundary = 0, closed = "left") +
labs(x = "EscShi", y = "Frequency")

# Natural Log transformation + 1 (to handle zeroes)
EscShi_transformed <- log(chickadeeData$EscShi + 1)

# Transformed EscShi histogram
ggplot(data = chickadeeData, aes(x = EscShi_transformed)) +
geom_histogram(col = "black", binwidth = 0.5,
boundary = 0, closed = "left") +
labs(x = "EscShi", y = "Frequency")
```

The transformed data is indeed easier to visualize. From visual inspection, the distribution appears to be approximately normally distributed. Let us assume that the variance within the groups are equal and perform the t-test.

```{r}

# Two sample t-test, assuming equal group variance 
t.test(EscShi ~ Source, data = chickadeeData, var.equal = TRUE)

# Two sample t-test of transformed data, assuming equal group variance
t.test(EscShi_transformed ~ Source, data = chickadeeData, var.equal = TRUE)

```

Based on the test, there is evidence to reject the null hypothesis. The test also shows that there is a higher mean abundance of bacteria identified as genus *Escherichia/Shigella* in the feather group.

-   Use a Mann-Whitney U-test (Wilcoxon rank sum test) to determine whether the population distribution of the abundance of bacteria identified as genus *Escherichia/Shigella* differs significantly between nests and feathers. [Use R function **`wilcox.test`**.]

As we desire to know if the results of the log-normal test would hold to the original population, we will carry out a Mann-Whitney U-test, which can be used in place of the two-sample t-test when the normal distribution assumption of the two-sample t-test cannot be met.

The Mann--Whitney U-test compares the distributions of two groups. It does not require as many assumptions as the two-sample t-test.

Therefore, we will carry it out on the untransformed data.

```{r}

# Mann-Whitney U-Test
wilcox.test(EscShi ~ Source, data = chickadeeData)

```

Based on the results of the test, we reject the null hypothesis, and find that there is evidence that the distributions of EscShi abundance between nests and feathers differ significantly.

-   Use a two-sample *t*-test to determine whether the mean abundance of bacteria identified as genus *Enterococcus* differs significantly between nests and feathers. [Consider transforming variable **`Entero`** and use R function **`t.test`**.]

We repeat the same procedure for genus *Enterococcus* as we did for genus *Escherichia/Shigella.*

```{r}
# Entero untransformed
ggplot(data = chickadeeData, aes(x = Entero)) +
geom_histogram(col = "black", binwidth = 10,
boundary = 0, closed = "left") +
labs(x = "Entero", y = "Frequency")

# Natural Log transformation + 1 (to handle zeroes)
Entero_transformed <- log(chickadeeData$Entero + 1)

# Transformed Entero histogram
ggplot(data = chickadeeData, aes(x = Entero_transformed)) +
geom_histogram(col = "black", binwidth = 0.5,
boundary = 0, closed = "left") +
labs(x = "Entero", y = "Frequency")

# Two sample t-test of transformed data, assuming equal group variance
t.test(Entero_transformed ~ Source, data = chickadeeData, var.equal = TRUE)

```

Based on the results of the test, we reject the null hypothesis, and find that the mean abundance of *Enterococcus* differs significantly between nests and feathers as well. However, the test shows that there is a higher mean abundance of bacteria identified as genus *Enterococcus* in the nest group.

-   Use a Mann-Whitney U-test (Wilcoxon rank sum test) to determine whether the population distribution of the abundance of bacteria identified as genus *Enterococcus* differs significantly between nests and feathers. [Use R function **`wilcox.test`**.]

```{r}

# Mann-Whitney U-Test
wilcox.test(Entero ~ Source, data = chickadeeData)

```

Based on the results of the test, we reject the null hypothesis, and find that the population distribution of the abundance of *Enterococcus* differs significantly between nests and feathers.

So far, we can interpret that there is a significant difference of the abundance of bacteria between nests and feathers, but there is a higher abundance of *Escherichia/Shigella* in the feather group, while there is a higher abundance of *Enterococcus* in the nest group.

-   Use analysis of variance to determine whether mean pathogen richness is related to habitat. [Use R functions **`lm`** and **`anova`**.]

Let us first investigate if mean pathogen richness requires transformation.

```{r}
# Summarize variable
describe(chickadeeData$PathRich)

# PathRich
ggplot(data = chickadeeData, aes(x = PathRich)) +
geom_histogram(col = "black", binwidth = 4,
boundary = 0, closed = "left") +
labs(x = "Pathogen Richness", y = "Frequency")

# Shapiro-Wilk Test for normality
shapiro.test(chickadeeData$PathRich)

```

Upon visual inspection, the pathogen richness data does appear to be normally distributed, and we conclude from the Shapiro-Wilk test that there is do significant difference from a normal distribution. Therefore, we will not transform this data.

Let us perform the analysis of variance:

```{r}
# Scatter Plot with linear model
ggplot(chickadeeData, aes(x=Habitat, y=PathRich)) +
  geom_point(aes(color=Habitat), size=3) +            # Scatter plot
  geom_smooth(method='lm', aes(group=1, color=Habitat)) + # Add a linear fit, colored by Habitat
  labs(title="Relationship between Pathogen Richness and Habitat",
       x="Habitat",
       y="Pathogen Richness") +
  theme_minimal()

```

Upon visual inspection of the linear model, discounting outliers, there does appear to be a linear relationship between pathogen richness and habitat, if we order from rural to urban.

```{r}

# Simple Linear Regression
PathRich_Habitat_Regression <- lm(PathRich ~ Habitat, data = chickadeeData)
summary(PathRich_Habitat_Regression)

# Calculate a 95% Confidence interval for the slope
# confint(PathRich_Habitat_Regression, level = 0.95)

# ANOVA
anova(PathRich_Habitat_Regression)
```

The linear model confirms this, as the estimates of coefficients increases as we compare habitats. The predictors are statistically significant, as the p values are below the alpha level of 0.05.

The Multiple R-squared tells us the proportion of the variance in the dependent variable that is predictable from the independent variable(s). In this case, it is 19.34%, and while it is not high, it is non-negligible.

The F-statistic tests whether at least one predictor variable has a non-zero coefficient, and the p-value is less than alpha 0.05, meaning that habitat is a significant predictor of pathogen richness.

ANOVA essentially tests whether the model, as a whole, explains a significant amount of the variance in the dependent variable.

The p-value associated with the F-statistic is less than the alpha level of 0.05, meaning that there is a significant effect of habitat on pathogen richness.

Based on these results, we can conclude that mean pathogen richness is related to habitat. The model as a whole is statistically significant, but the Multiple R-squared value suggests that only about 19.34% of the variability in pathogen richness can be explained by habitat, so there may be other factors at play as well.

Thus, there is evidence to support that habitat is a significant predictor of pathogen richness, but it is not the only factor influencing it. Furthermore, as it is implied that habitat is categorized based on human population density, we can infer that pathogen richness increases with human population density.

-   Use a Kruskal-Wallis test to determine whether mean pathogen richness is related to habitat. [Use R function **`kruskal.test`**.]

```{r}

# Kruskal-Wallis Test
kruskal.test(PathRich ~ Habitat, data = chickadeeData)

```

The Kruskal-Wallis test is a non-parametric alternative to single factor ANOVA, and is used to test if there are statistically significant differences between the medians of three or more independent groups. Unlike ANOVA, it does not assume a normal distribution of the residuals or homogeneity of variance.

In this case, the p-value associated with the Kruskal-Wallis chi-squared test statistic is below alpha of 0.01, and we can conclude that the differences in the groups are due to random chance. From this conclusion, we have gathered evidence to support the inferences from the linear model.

-   Use the Tukey-Kramer method to which habitats differ with respect to mean pathogen richness. [Use R functions **`emmeans`** and **`contrast`**.]

```{r}

# Tukey-Kramer test
# Often used as a post-hoc analysis after a one-way ANOVA or Kruskal-Wallis test to determine which specific groups differ from each other.
pathogenPairs <- emmeans(PathRich_Habitat_Regression, specs = "Habitat")
pathogenUnplanned <- contrast(pathogenPairs, method = "pairwise",
adjust = "tukey")

pathogenUnplanned
```

Let us interpret each row.

1.  Rural vs Semi-Urban: Pathogen richness is lower in rural areas than semi-urban areas, but the p-value is greater than the alpha level of 0.05. This difference is not statistically significant.
2.  Rural vs Urban: Pathogen richness is lower in rural areas than urban areas, and the p-value is lower than the alpha level of 0.05. This difference is statistically significant.
3.  Semi-Urban vs Urban: Pathogen richness is lower in semi-urban areas than urban areas, but the p-value is greater than the alpha level of 0.05. This difference is not statistically significant.

From the Tukey-Kramer test, we can conclude that pathogen richness is significantly higher in urban areas compared to rural areas, but there are no statistically significant differences in pathogen richness between rural and semi-urban areas, or between semi-urban and urban areas based on this data.

These results support the linear regression model and Kruskal-Wallis test, reinforcing the idea that pathogen richness varies with habitat type.

-   Use simple linear regression to determine which of **`WingChord`**, **`BirdWeight`**, **`TailLen`**, or **`TarsusLen`** is most linearly associated with pathogen richness on feathers. [Use R functions **`lm`** and **`summary`**.]

```{r}

# Select the subset df for feathers
summary(df_feather)
unique(df_feather)

# Fit a linear model to each relationship
fit_WingChord <- lm(df_feather$PathRich ~ df_feather$WingChord)
fit_BirdWeight <- lm(df_feather$PathRich ~ df_feather$BirdWeight)
fit_TailLen <- lm(df_feather$PathRich ~ df_feather$TailLen)
fit_TarsusLen <- lm(df_feather$PathRich ~ df_feather$TarsusLen)

# Summarize the fits
summary(fit_WingChord)
summary(fit_BirdWeight)
summary(fit_TailLen)
summary(fit_TarsusLen)

# Alternatively, fit a multiple linear regression model
fit_all <- lm(PathRich ~ WingChord + BirdWeight + TailLen + TarsusLen, data = df_feather)
summary(fit_all)

```

The Highest R-squared value is considered the most linearly associated with the dependent variable, while the variable with the lowest p-value is the most statistically significant predictor of the dependent variable. By using a multiple linear regression model, we cannot compare the R-squared values between each of the fits, so it is preferable to fit each one separately.

Let us inspect the metrics of each fit:

-   Wing Chord: Coefficient estimate of 1.290, with a p-value of 0.3262. Multiple R-squared of 0.03443.

-   Weight: Coefficient estimate of 0.9894, with a p-value of 0.5492. Multiple R-squared of 0.01296.

-   Tail Length: Coefficient estimate of 2.148, with a p-value of 0.06816. Multiple R-squared of 0.1139.

-   Tarsus Length: Coefficient estimate of -5.501, with a p-value of 0.1971. Multiple R-squared of 0.0587.

From these tests, none of the results are statistically significant, as the p-values are greater than the alpha level of 0.05. However, Tail length is the most likely to be significant, relative to the other variables, due to its lower p-value. It also has the greatest coefficient estimate, and multiple R-squared value.

It should be noted that tarsus length is negatively correlated with pathogen richness based on this data, but the p-value is too high to be statistically significant. This however, may guide our intuition for later.

As the multiple linear regression model results in a p-value greater than the alpha level of 0.05, we fail to reject the null hypothesis that the model predictors have no effect on the response variable.

-   For the simple linear regression model selected in Question 11, investigate whether there are any outliers. An outlier in the context of linear regression is an observation with an extreme difference between the observed response value and the predicted response value from the model. Use the **`filter`** function to create a new data frame that excludes the most extreme outlier and refit the simple linear regression model. Report the results for the model fit to the data frame excluding the outlier and use this data frame to answer Questions 13-18.

We will now account for outliers in the data:

```{r}

# Investigate outliers visually

# Individually
boxplot(df_feather$PathRich) # Outlier > 60
boxplot(df_feather$WingChord)
boxplot(df_feather$BirdWeight) # Outliers > 13
boxplot(df_feather$TailLen)
boxplot(df_feather$TarsusLen)

```

We can see some outliers in PathRich and BirdWeight, based on falling outside of the interquartile range in the boxplots. Let us filter them, then plot the filtered data:

```{r}

# Filter outliers
df_feather <- filter(df_feather, PathRich < 66) # Outlier > 60
df_feather <- filter(df_feather, BirdWeight < 14) # Outlier > 13

# Check if filters were successful
boxplot(df_feather$PathRich) # Outlier > 60
boxplot(df_feather$BirdWeight) # Outliers > 13

# Check Relationships for more potential outliers
plot(PathRich ~ WingChord, data = df_feather)
plot(PathRich ~ BirdWeight, data = df_feather)
plot(PathRich ~ TailLen, data = df_feather)
plot(PathRich ~ TarsusLen, data = df_feather)

# BirdWeight only has 1 value at 13, treat it as an outlier
df_feather <- filter(df_feather, BirdWeight < 12.5)
plot(PathRich ~ BirdWeight, data = df_feather)

```

After removing the outliers, let us fit the linear model once again:

```{r}

# Fit a linear model to each relationship
fit_WingChord <- lm(df_feather$PathRich ~ df_feather$WingChord)
fit_BirdWeight <- lm(df_feather$PathRich ~ df_feather$BirdWeight)
fit_TailLen <- lm(df_feather$PathRich ~ df_feather$TailLen)
fit_TarsusLen <- lm(df_feather$PathRich ~ df_feather$TarsusLen)

# Summarize the fits
summary(fit_WingChord)
summary(fit_BirdWeight)
summary(fit_TailLen)
summary(fit_TarsusLen)

# Alternatively, fit a multiple linear regression model
fit_all <- lm(PathRich ~ WingChord + BirdWeight + TailLen + TarsusLen, data = df_feather)
summary(fit_all)
```

Excluding the outliers, we find that two variables are statistically significant:

-   Wing Chord: Coefficient estimate of 2.260, with a p-value of 0.03014. Multiple R-squared of 0.2141.

-   Tail Length: Coefficient estimate of 2.1883, with a p-value of 0.03072. Multiple R-squared of 0.2128.

The multiple linear regression model results in a p-value less than the alpha level of 0.05, therefore we reject the null hypothesis that the model predictors have no effect on the response variable, and conclude that the model as a whole is significant, meaning that there exists predictors that have an effect on the response variable.

-   Find the best multiple linear regression model for predicting pathogen richness on feathers from two predictors out of **`WingChord`**, **`BirdWeight`**, **`TailLen`**, and **`TarsusLen`**. [Use R functions **`lm`** and **`summary`**.]

```{r}

# WingChord + BirdWeight
fit_WingChord_BirdWeight <- lm(PathRich ~ WingChord + BirdWeight, data = df_feather)
summary(fit_WingChord_BirdWeight)

# WingChord + TailLen
fit_WingChord_TailLen <- lm(PathRich ~ WingChord + TailLen, data = df_feather)
summary(fit_WingChord_TailLen)

# WingChord + TarsusLen
fit_WingChord_TarsusLen <- lm(PathRich ~ WingChord + TarsusLen, data = df_feather)
summary(fit_WingChord_TarsusLen)

# BirdWeight + TailLen
fit_BirdWeight_TailLen <- lm(PathRich ~ BirdWeight + TailLen, data = df_feather)
summary(fit_BirdWeight_TailLen)

# BirdWeight + TarsusLen
fit_BirdWeight_TarsusLen <- lm(PathRich ~ BirdWeight + TarsusLen, data = df_feather)
summary(fit_BirdWeight_TarsusLen)

# TailLen + TarsusLen
fit_TailLen_TarsusLen <- lm(PathRich ~ TailLen + TarsusLen, data = df_feather)
summary(fit_TailLen_TarsusLen)

```

We shall compare the results by hand, to determine the models which result in p-values below the alpha level of 0.05, and have the highest Multiple R-squared values, Residual Standard Error, and Adjusted R-Squared values (if necessary).

-   Wing chord and tarsus length has a p-value less than the alpha level of 0.05. It has an R-squared value of 0.54, Adjusted R-squared of 0.4916, and a RSE of 7.946 on 19 degrees of freedom.
-   Bird weight and tarsus length has a p-value less than the alpha level of 0.05. It has an R-squared value of 0.2799, Adjusted R-squared of 0.2042, and a RSE of 9.941 on 19 degrees of freedom.
-   Tail length and tarsus length has a p-value less than the alpha level of 0.05. It has an R-squared value of 0.4542, Adjusted R-squared of 0.3968, and a RSE of 8.655 on 19 degrees of freedom.

From these results, the best model for predicting pathogen richness on feathers from two predictors is the wing chord and tarsus length model, based on all three metrics taken into consideration. This is in agreement with the single linear regression model results which suggested wing chord was one of the best predictors.

The single linear regression model suggested that tail length as also a significant predictor of pathogen richness on feathers, and the multiple regression model does support this conclusion.

-   Use a two-sample *t*-test to determine whether mean pathogen richness on feathers differs significantly between male and female birds. [Use R function **`t.test`**.]

```{r}

# Two-sample t-test
# Determine whether the mean of the dependent variable differs significantly between the independent variables, i.e. compare the means of two groups to see if they are statistically different.

# Assess normality and equal variance
ggplot(df_feather, aes(x = PathRich)) +
geom_histogram(col = "black", binwidth = 3,
boundary = 0, closed = "left") +
facet_wrap( ~ BirdSex, ncol = 1, scales = "free_y") +
labs(x = "Pathogen richness", y = "Sex")

# Q-Q Plot (Quantile-Quantile Plot)
qqnorm(df_feather$PathRich)
qqline(df_feather$PathRich)

# Levene's Test to check for equal variance
leveneTest(df_feather$PathRich ~ df_feather$BirdSex) # fail to reject the null hypothesis, suggesting it is reasonable to assume equal variances.

# Check for missing values
sum(is.na(df_feather$PathRich)) # none

# Filter missing values (if there are any)
#featherSub <- filter(df_feather, PathRich != "NA")

# t-test assuming equal variance
t.test(PathRich ~ BirdSex, data = df_feather, var.equal = TRUE)

```

From the results of the Two Sample t-test, as the p-value is less than the alpha level of 0.05, we fail to reject the null hypothesis that difference in the means is 0. We conclude that there is no reason to assume a significant difference in the means between sex.

-   Starting from the simple linear regression model in Question 12, use analysis of covariance to investigate whether the linear association in the model differs for male and female birds. [Use R functions **`lm`** and **`summary`**.]

```{r}

# ANCOVA

# Wing Chord

# Scatterplot by Sex
ggplot(df_feather, aes(WingChord, PathRich, shape = BirdSex)) +
geom_point(size = 2) +
scale_shape_manual(values = c(16, 1)) +
labs(x = "Wing Chord", y = "Pathogen Richness")

# Fit the main effects model (with no interaction term)
featherNoInteractModel <- lm(PathRich ~ WingChord + BirdSex,
data = df_feather)
df_feather$fit0 <- predict(featherNoInteractModel)
ggplot(df_feather, aes(WingChord, PathRich, colour = BirdSex,
shape = BirdSex, linetype=BirdSex)) +
geom_line(aes(y = fit0), size = 1, color = "black") +
geom_point(size = 2) +
scale_colour_manual(values = c("black", "black")) +
scale_shape_manual(values = c(16, 1)) +
labs(x = "Wing Chord", y = "Pathogen Richness")

summary(featherNoInteractModel)

# Fit the interaction model
featherInteractModel <- lm(PathRich ~ WingChord * BirdSex,
data = df_feather)
ggplot(df_feather, aes(WingChord, PathRich, colour = BirdSex,
shape = BirdSex, linetype=BirdSex)) +
geom_smooth(method = "lm", size = 1, se = FALSE, col = "black") +
geom_point(size = 2) +
scale_colour_manual(values = c("black", "black")) +
scale_shape_manual(values = c(16, 1)) +
labs(x = "Wing Chord", y = "Pathogen Richness")

summary(featherInteractModel)

# ANOVA table
anova(featherNoInteractModel, featherInteractModel)
# No significant difference

# Tail Length
# Scatterplot by Sex
ggplot(df_feather, aes(TailLen, PathRich, shape = BirdSex)) +
geom_point(size = 2) +
scale_shape_manual(values = c(16, 1)) +
labs(x = "Tail Length", y = "Pathogen Richness")

# Fit the main effects model (with no interaction term)
featherNoInteractModel <- lm(PathRich ~ TailLen + BirdSex,
data = df_feather)
df_feather$fit0 <- predict(featherNoInteractModel)
ggplot(df_feather, aes(TailLen, PathRich, colour = BirdSex,
shape = BirdSex, linetype=BirdSex)) +
geom_line(aes(y = fit0), size = 1, color = "black") +
geom_point(size = 2) +
scale_colour_manual(values = c("black", "black")) +
scale_shape_manual(values = c(16, 1)) +
labs(x = "Tail Length", y = "Pathogen Richness")

summary(featherNoInteractModel)

# Fit the interaction model
featherInteractModel <- lm(PathRich ~ TailLen * BirdSex,
data = df_feather)
ggplot(df_feather, aes(TailLen, PathRich, colour = BirdSex,
shape = BirdSex, linetype=BirdSex)) +
geom_smooth(method = "lm", size = 1, se = FALSE, col = "black") +
geom_point(size = 2) +
scale_colour_manual(values = c("black", "black")) +
scale_shape_manual(values = c(16, 1)) +
labs(x = "Tail Length", y = "Pathogen Richness")

summary(featherInteractModel)

# ANOVA table
anova(featherNoInteractModel, featherInteractModel)
# No significant difference


```

Based on the results of the ANCOVA tests, we fail to reject the null hypothesis that there is no difference in the models, and conclude that there is no reason to assume statistically significant differences in linear association between bird sexes.

Let us now perform some multivariate methods on the original dataset (feather and nest group) of the pathogen groups:

```{r}

# Correlation matrix

# Select only numeric columns
numeric_data <- select_if(chickadeeData, is.numeric)

# Calculate the correlation matrix
cor_matrix <- cor(numeric_data)
print(cor_matrix)

# Pick column pairs

# Scatter plot matrix (pairs)
ggpairs(chickadeeData[, c("EscShi", "Entero")], axisLabels = "none") +
theme_bw()

# Clustered Heatmap of Correlations between variables
numeric_variables <- chickadeeData[, c("EscShi", "Entero", "PathRich")]
pheatmap(cor(numeric_variables), cell.width = 10, cell.height = 10)

# Centering and Scaling the Data
apply(numeric_data, 2, mean)
apply(numeric_data, 2, sd)
scaledBirds <- scale(numeric_data)
apply(numeric_data, 2, mean)
apply(numeric_data, 2, sd)

# Display in scatterplot marked by sex
ggplot(data.frame(scaledBirds, sex = chickadeeData$BirdSex),
aes(x = EscShi, y = Entero, group = sex)) +
geom_point(aes(color = sex), size = 3)


```

Simply said, we find that the magnitude of correlation between pathogen groups are low.

-   Apply principal component analysis to the variables **`WingChord`**, **`BirdWeight`**, **`TailLen`**, and **`TarsusLen`**. [Use R functions **`scale`**, **`prcomp`**, and **`summary`**. Also, summarize the principal component loadings and use R function **`fviz_pca_ind`** with argument **`habillage`** to visualize the results and colour the observations by bird sex.]

```{r}

# Quick PCA

# Gather the numeric variables
numeric_variables <- chickadeeData[, c("WingChord", "BirdWeight", "TailLen", "TarsusLen")]

scaledBirds <- data.frame(scale(numeric_variables))

ggplot(scaledBirds, aes(x = WingChord, y = BirdWeight)) +
geom_point(size = 2, shape = 21) +
geom_point(aes(y = 0), colour = "red") +
geom_segment(aes(xend = WingChord, yend = 0),
colour = "red",
arrow = arrow(length = unit(0.15, "cm")))

scaledBirds_clean_rows <- na.omit(scaledBirds)
# clustered heatmap of correlations
pheatmap(cor(scaledBirds_clean_rows), treeheight_row = 0.2)

# Perform PCA
pca_result <- prcomp(scaledBirds_clean_rows, center = TRUE, scale. = TRUE) 
# center and scale. are usually TRUE for standardized data, but since the data is already scaled, they are not strictly necessary

summary_pca <- summary(pca_result)
print(summary_pca)

# Explain the first 2 principal components (rotation matrix)
pca_result$rotation[, 1:2]

pca_result$sdev # standard deviations
pca_result$sdev^2 # eigenvalues/variances
pca_result$sdev^2 / sum(pca_result$sdev^2) # proportion of variance

get_eig(pca_result) # eigenvalues/variances
fviz_eig(pca_result, geom = "bar", bar_width = 0.4) +
ggtitle("")

# Scree Plot
fviz_eig(pca_result, addlabels = TRUE)

# Biplot of attributes
fviz_pca_var(pca_result, col.var = "black")

# Contribution of each variable
fviz_cos2(pca_result, choice = "var", axes = 1:2)

# Biplot combined with cos2
fviz_pca_var(pca_result, col.var = "cos2",
            gradient.cols = c("black", "orange", "green"),
            repel = TRUE)

# PCA Scatter Plot
chickadee_clean_rows <- na.omit(chickadeeData) # we need to ensure the rows are equal from the dataset not used in the pca

fviz_pca_ind(pca_result, habillage = chickadee_clean_rows$BirdSex,
geom = "point") +
ggtitle("") +
ylim(c(-6.5,7.5)) +
coord_fixed()

# PCA BiPlot
fviz_pca_biplot(pca_result, geom = "point",
habillage = chickadee_clean_rows$BirdSex,
col.var = "violet", addEllipses = TRUE,
ellipse.level = 0.69) +
ggtitle("") +
ylim(c(-4,5)) +
coord_fixed()


```

From the biplot of the variables with respect to the principal components, we can observe that the female group is lower in both dimensions, compared to the male group. We see that Tarsus length is least correlated to the other variables, while the other three are positively correlated to each other. Furthermore, we observe that tarsus length, wing chord, and tail length are the top contributors to the principal components.

-   Fit a simple linear regression model with response variable **`PathRich`** and predictor variable equal to the first principal component from Question 16. Compare this model with the simple linear regression model in Question 12. [Use R functions **`lm`** and **`summary`**.]

```{r}

# Extract the principal component scores
pc1_scores <- pca_result$x[, 1]
pc2_scores <- pca_result$x[, 2]

# Fit a linear model to each relationship
fit_PC1 <- lm(chickadee_clean_rows$PathRich ~ pc1_scores)

# Make predictions using the linear model
chickadee_clean_rows$pc1_predicted <- predict(fit_PC1, newdata = chickadee_clean_rows)

# Scatterplot by Sex
ggplot(chickadee_clean_rows, aes(x = pc1_scores, y = PathRich)) +
  geom_point(aes(shape = BirdSex, color = BirdSex), size = 2) + 
  scale_shape_manual(values = c(16, 1)) +
  geom_line(aes(y = pc1_predicted), size = 1, color = "black") + 
  labs(x = "Dimension 1", y = "Pathogen Richness") +
  scale_colour_manual(values = c("red", "blue"))


# Make predictions using the previous simple linear model
fit_WingChord_cleaned <- lm(chickadee_clean_rows$PathRich ~ chickadee_clean_rows$WingChord)
chickadee_clean_rows$predicted_WingChord <- predict(fit_WingChord_cleaned, newdata = chickadee_clean_rows)

# Scatterplot by Sex with both models (along Dimension 1)
ggplot(chickadee_clean_rows, aes(x = pc1_scores, y = PathRich)) +
  geom_point(aes(shape = BirdSex, color = BirdSex), size = 2) + 
  scale_shape_manual(values = c(16, 1)) +
  geom_line(aes(y = pc1_predicted), size = 1, color = "black") + 
    geom_line(aes(x = pc1_scores, y = predicted_WingChord), size = 1, color = "orange", linetype = "dashed") +
  labs(x = "Dimension 1", y = "Pathogen Richness") +
  scale_colour_manual(values = c("red", "blue"))

# Summarize the fits
summary(fit_PC1)
summary(fit_WingChord_cleaned)
summary(fit_WingChord)

```

The linear model using the first principal component

.. Redo PCA and linear model using df_feather

-   Fit a multiple linear regression model with response variable **`PathRich`** and predictor variables equal to the first two principal components from Question 16. Compare this model with the multiple linear regression model in Question 13. [Use R functions **`lm`** and **`summary`**.]

```{r}

# Extract the principal component scores
pc1_scores <- pca_result$x[, 1]
pc2_scores <- pca_result$x[, 2]

# Fit a linear model to each relationship for principal components
fit_all_PC <- lm(chickadee_clean_rows$PathRich ~ pc1_scores + pc2_scores)

# Compare summaries
summary(fit_all_PC)
summary(fit_all)

```

Redo based on df_feather

-   Apply metric multidimensional scaling (MDS) to the dissimilarities data in the **`ChickadeeDissimilarities.csv`** file. [Use R function **`cmdscale`** to perform the metric MDS and use function **`ggplot`** to create a scatterplot that projects the data onto the first two principal coordinates. Then use the **`shape`** aesthetic to first mark the points by **`Habitat`** and then by **`Source`**.] Does the composition of the microbial communities appear to be related to **`Habitat`** or **`Source`**?

```{r}

# Microbial community composition data for 2607 taxa was also used to calculate Bray Curtis dissimilarities between the 47 sites
distChickadee <- read.csv("ChickadeeDissimilarities.csv", row.names=1)
distChickadee[1:6, 1:6]

# clustered heatmap
pheatmap(distChickadee[1:12, 1:12], cluster_rows = TRUE,
treeheight_row = 0.0001, treeheight_col = 0.8,
fontsize_col = 8, cellwidth = 13, cellheight = 13)

# Classical (metric) multidimensional scaling (MDS), also known as principal coordinates analysis
MDSChickadee <- cmdscale(distChickadee, eig = TRUE)

# Create a plotbar function to plot the eigenvalues in a scree plot.
plotbar <- function(res, m = 9) {
ggplot(data.frame(list(eig = res$eig[seq_len(m)],
k = seq(along = res$eig[seq_len(m)]))),
aes(x = k, y = eig)) +
scale_x_discrete("k", limits = factor(seq_len(m))) +
theme_minimal() +
geom_bar(stat="identity", width=0.5, color="orange",
fill="pink")
}

plotbar(MDSChickadee, m = 5)

# Project the cities onto the first two coordinates created from the distances.
MDSChick <- data.frame(list(PCo1 = MDSChickadee$points[, 1],
PCo2 = MDSChickadee$points[, 2],
labs = rownames(MDSChickadee$points)))
ggplot(MDSChick, aes(x = PCo1, y = PCo2, label = labs)) +
geom_point(color = "red") +
#xlim(-1950, 2000) +
#ylim(-1150, 1200) +
coord_fixed() +
geom_text_repel(size = 4, max.overlaps = 100)

#To re-orient the “map” so north is at the top and west is on the left, reverse the signs of the principal coordinates:
ggplot(MDSChick, aes(x = -PCo1, y = -PCo2, label = labs)) +
geom_point(color = "red") +
coord_fixed() +
geom_text_repel(size = 4, max.overlaps = 100)

# Merge the datasets
MDSChick_merged <- merge(MDSChick, chickadeeData, by.x = "labs", by.y = "Site")
print(MDSChick_merged)

# By Habitat
ggplot(MDSChick_merged, aes(x = PCo1, y = PCo2)) +
  geom_point(aes(shape = Habitat)) +
  coord_fixed() +
  scale_shape_manual(values = c(16, 17, 18))

# Zoom in
ggplot(MDSChick_merged, aes(x = PCo1, y = PCo2)) +
  geom_point(aes(shape = Habitat)) +
  xlim(-0.25, 0.25) +
  ylim(-0.25, 0.25) +
  coord_fixed() +
  scale_shape_manual(values = c(16, 17, 18))

# By Source
ggplot(MDSChick_merged, aes(x = PCo1, y = PCo2)) +
  geom_point(aes(shape = Source)) +
  coord_fixed() +
  scale_shape_manual(values = c(16, 17))

# Zoom in
ggplot(MDSChick_merged, aes(x = PCo1, y = PCo2)) +
  geom_point(aes(shape = Source)) +
  xlim(-0.25, 0.25) +
  ylim(-0.25, 0.25) +
  coord_fixed() +
  scale_shape_manual(values = c(16, 17))

```

Upon visual inspection of the MDS, microbial community composition appears to be more closely associated with source.

-   Apply nonmetric multidimensional scaling (NMDS) to the dissimilarities data in the **`ChickadeeDissimilarities.csv`** file. [Use R function **`metaMDS`** to perform the NMDS and use function **`ggplot`** to create a scatterplot that projects the data onto the first two NMDS axes. Then use the **`shape`** aesthetic to first mark the points by **`Habitat`** and then by **`Source`**.] Does the composition of the microbial communities appear to be related to **`Habitat`** or **`Source`**?

```{r}

# Nonmetric Multidimensional Scaling (NMDS)

# Recall that NMDS is more robust as it does not use metric distances, but it is more computationally intensive

# Create a function to conduct a nonmetric multidimensional scaling (NMDS) by running the metaMDS function (in the vegan package) multiple times for a range of possible values for k (the number of dimensions) and recording the stress values (a measure of goodness of fit; the lower the better):

nmds.stress <- function(x, sim = 100, kmax = 4) {
sapply(seq_len(kmax), function(k)
replicate(sim, metaMDS(x, k = k, autotransform = FALSE)$stress))
}

stress <- nmds.stress(distChickadee, sim = 100)

# Look at boxplots of the results as a diagnostic plot to choose k:
dfstr <- melt(stress, varnames = c("replicate","dimensions"))
ggplot(dfstr, aes(y = value, x = dimensions, group = dimensions)) +
geom_boxplot()

# Compare the observed distances and their approximations using a Shepard plot for k = 2:
nmdsk2 <- metaMDS(distChickadee, k = 2, autotransform = FALSE)
stressplot(nmdsk2, pch = 20)

# Plot the different colors using the first two NMDS axes and notice the results are similar to the MDS solution in this case:

dfnmdsk2 <-
data.frame(list(NmMDS1 = nmdsk2$points[,1],
NmMDS2 = nmdsk2$points[,2],
Site = rownames(distChickadee)
))

# Merge the two data frames by the common column
merged_df <- merge(dfnmdsk2, chickadeeData, by = "Site")

# Plotting by Habitat
ggplot(merged_df, aes(x = NmMDS1, y = NmMDS2)) +
  geom_point(aes(colour = Habitat), size = 4) +
  geom_text_repel(aes(label = Site), size = 3, max.overlaps = 100)

# Plotting by Source
ggplot(merged_df, aes(x = NmMDS1, y = NmMDS2)) +
  geom_point(aes(colour = Source), size = 4) +
  geom_text_repel(aes(label = Site), size = 3, max.overlaps = 100)


```

The Shepard plot suggests that both the linear and non-metric fits are excellent fits, and indicates that the lower-dimensional representation of the data is capturing almost all of the dissimilarity structure in the original high-dimensional data. The higher R-squared value in the Non-Metric Fit suggests that the NMDS solution is a slightly better model, strictly considering R-squared.

From these scatter plots, the composition of the microbial communities appear to be related more to source, rather than habitat.

## 6. Statistical Inference - Estimation (if applicable)

### Point Estimation

-   Compute a single value that estimates the parameter of interest.

### Interval Estimation

-   Compute a confidence interval that contains the parameter with a specific level of confidence.

## 7. Model Validation

### Assumptions Checking

-   Check whether the assumptions of the chosen model are met.

### Goodness-of-fit

-   Evaluate how well the model fits the data.

### Residual Analysis

-   Analyze residuals to understand the variance unexplained by the model.

### Cross-Validation

-   Use techniques like k-fold cross-validation to ensure model stability and to prevent overfitting.

## 8. Interpretation

### Prediction

-   How will predictions be generated, validated, and used?

### Results Interpretation

-   Interpret the results in the context of the problem.

### Limitations

-   Discuss any limitations or assumptions in the analysis.

## 9. Communcation

### Report Writing

-   Write a clear and concise report or paper that details the analysis.

### Visualization Tools

-   Depending on the audience, create interactive dashboards or other visualization tools to make results accessible and understandable.

### Presentation

-   Present the findings to stakeholders or peers.

## 10. Ethical Considerations

-   Always ensure that the data and methods used adhere to ethical standards, especially if the data contains personal information. Consider privacy, consent, potential biases in the data, and the implications of your analysis and predictions.

## References

1.  www.tru.ca, Thompson Rivers University. "BIOL 4001: Biostatistics." *Thompson Rivers University*, <http://www.tru.ca/distance/courses/biol4001.html.> Accessed 20 Aug. 2023.

2.  *Introduction to R*. <https://www.zoology.ubc.ca/~bio501/R/workshops/workshops-intro.html.> Accessed 20 Aug. 2023.

3.  *Resources for The Analysis of Biological Data*. <https://whitlockschluter3e.zoology.ubc.ca/index.html.> Accessed 20 Aug. 2023.
